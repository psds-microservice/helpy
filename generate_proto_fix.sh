#!/bin/bash

# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è proto —Ñ–∞–π–ª–æ–≤ –¥–ª—è helpy —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Go –∫–æ–¥ –∏–∑ proto —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è proto —Ñ–∞–π–ª–æ–≤ –¥–ª—è helpy"
echo "========================================"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
PROTO_DIR="."
GEN_DIR="."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
mkdir -p $GEN_DIR

echo "üìÅ Proto files: $PROTO_DIR"
echo "üìÅ Output: $GEN_DIR"
echo ""

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Go —Ñ–∞–π–ª—ã –∏–∑ –≤—Å–µ—Ö proto —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go —Ñ–∞–π–ª–æ–≤..."
for proto_file in $(find $PROTO_DIR -name "*.proto"); do
    echo "üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞: $(basename $proto_file)"

    protoc \
        --go_out=$GEN_DIR \
        --go_opt=paths=source_relative \
        --go-grpc_out=$GEN_DIR \
        --go-grpc_opt=paths=source_relative \
        $proto_file

    if [ $? -eq 0 ]; then
        echo "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: $(basename $proto_file)"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: $(basename $proto_file)"
    fi
done

echo ""
echo "========================================"
echo "üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìÅ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤: $GEN_DIR"
echo ""
echo "üìã –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö:"
echo "1. –î–æ–±–∞–≤—å—Ç–µ helpy –∫–∞–∫ git submodule –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ proto —Ñ–∞–π–ª—ã"
echo "2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —á–µ—Ä–µ–∑ go.mod"
echo "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ import \"github.com/psds-microservice/helpy/gen\""